#!/bin/bash

GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

BASE_URL="http://localhost:8000/api/v1"
PASSED=0
FAILED=0

test_api() {
  local name="$1"
  local method="$2"
  local url="$3"
  local data="$4"
  
  if [ "$method" = "GET" ]; then
    response=$(curl -s -w "\nHTTP:%{http_code}" -X GET "$url" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN")
  elif [ "$method" = "POST" ]; then
    response=$(curl -s -w "\nHTTP:%{http_code}" -X POST "$url" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" -H "Content-Type: application/json" -d "$data")
  elif [ "$method" = "PUT" ]; then
    response=$(curl -s -w "\nHTTP:%{http_code}" -X PUT "$url" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" -H "Content-Type: application/json" -d "$data")
  elif [ "$method" = "DELETE" ]; then
    response=$(curl -s -w "\nHTTP:%{http_code}" -X DELETE "$url" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN")
  fi
  
  code=$(echo "$response" | grep "HTTP:" | cut -d: -f2)
  
  if [ "$code" = "200" ] || [ "$code" = "201" ]; then
    echo -e "${GREEN}✅ $name${NC}"
    ((PASSED++))
    echo "$response" | sed '$d'
    return 0
  else
    echo -e "${RED}❌ $name (HTTP $code)${NC}"
    ((FAILED++))
    echo "$response" | sed '$d' | head -5
    return 1
  fi
}

echo -e "${CYAN}=========================================${NC}"
echo -e "${CYAN}  TESTING REMAINING SCHOOL ADMIN APIs  ${NC}"
echo -e "${CYAN}=========================================${NC}"

# Setup
echo -e "\n${CYAN}=== SETUP ===${NC}"
login=$(curl -s -X POST "$BASE_URL/auth/login" -H "Content-Type: application/json" \
  -d '{"email":"superadmin@compasse.net","password":"Nigeria@60"}')
SUPER_TOKEN=$(echo "$login" | jq -r '.token')

timestamp=$(date +%s)
school=$(curl -s -X POST "$BASE_URL/schools" -H "Authorization: Bearer $SUPER_TOKEN" -H "Content-Type: application/json" \
  -d "{\"name\":\"Test $timestamp\",\"subdomain\":\"test$timestamp\",\"email\":\"admin@test.com\",\"phone\":\"+234-800\",\"address\":\"Test\",\"plan_id\":1}")
SCHOOL_ID=$(echo "$school" | jq -r '.school.id')
SUBDOMAIN=$(echo "$school" | jq -r '.tenant.subdomain')
ADMIN_EMAIL=$(echo "$school" | jq -r '.tenant.admin_credentials.email')
ADMIN_PASSWORD=$(echo "$school" | jq -r '.tenant.admin_credentials.password')

admin_login=$(curl -s -X POST "$BASE_URL/auth/login" -H "Content-Type: application/json" -H "X-Subdomain: $SUBDOMAIN" \
  -d "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\"}")
ADMIN_TOKEN=$(echo "$admin_login" | jq -r '.token')
echo -e "${GREEN}Setup complete${NC}\n"

# Get prerequisites
ACADEMIC_YEAR_ID=$(curl -s "$BASE_URL/academic-years" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" | jq -r '.[0].id')
TERM_ID=$(curl -s "$BASE_URL/terms" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" | jq -r '.[0].id')

# Create test data
class=$(curl -s -X POST "$BASE_URL/classes" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" -H "Content-Type: application/json" \
  -d "{\"name\":\"Grade 1\",\"academic_year_id\":$ACADEMIC_YEAR_ID,\"term_id\":$TERM_ID,\"capacity\":30}")
CLASS_ID=$(echo "$class" | jq -r '.id')

student=$(curl -s -X POST "$BASE_URL/students" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" -H "Content-Type: application/json" \
  -d "{\"first_name\":\"John\",\"last_name\":\"Doe\",\"class_id\":$CLASS_ID,\"date_of_birth\":\"2010-08-20\",\"gender\":\"male\"}")
STUDENT_ID=$(echo "$student" | jq -r '.student.id // .id')

teacher=$(curl -s -X POST "$BASE_URL/teachers" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" -H "Content-Type: application/json" \
  -d '{"first_name":"Jane","last_name":"Smith","email":"jane@test.com","phone":"+234-800","date_of_birth":"1985-05-15","gender":"female","employment_date":"2025-01-01"}')
TEACHER_ID=$(echo "$teacher" | jq -r '.teacher.id // .id')

dept=$(curl -s -X POST "$BASE_URL/departments" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" -H "Content-Type: application/json" \
  -d '{"name":"Science","code":"SCI"}')
DEPT_ID=$(echo "$dept" | jq -r '.department.id // .id')

subject=$(curl -s -X POST "$BASE_URL/subjects" -H "Authorization: Bearer $ADMIN_TOKEN" -H "X-Subdomain: $SUBDOMAIN" -H "Content-Type: application/json" \
  -d "{\"name\":\"Mathematics\",\"code\":\"MATH\",\"department_id\":$DEPT_ID}")
SUBJECT_ID=$(echo "$subject" | jq -r '.subject.id // .id')

echo -e "${CYAN}Test data created: CLASS_ID=$CLASS_ID, STUDENT_ID=$STUDENT_ID, TEACHER_ID=$TEACHER_ID, SUBJECT_ID=$SUBJECT_ID${NC}\n"

# 1. SUBSCRIPTIONS
echo -e "${CYAN}=== 1. SUBSCRIPTIONS ===${NC}"
test_api "Get Subscription Plans" "GET" "$BASE_URL/subscriptions/plans"
test_api "Get Modules" "GET" "$BASE_URL/subscriptions/modules"
test_api "Get Subscription Status" "GET" "$BASE_URL/subscriptions/status"
test_api "Get School Modules" "GET" "$BASE_URL/subscriptions/school/modules"
test_api "Get School Limits" "GET" "$BASE_URL/subscriptions/school/limits"

# 2. SETTINGS
echo -e "\n${CYAN}=== 2. SETTINGS ===${NC}"
test_api "Get Settings" "GET" "$BASE_URL/settings"
test_api "Update Settings" "PUT" "$BASE_URL/settings" '{"school_name":"Updated School"}'

# 3. GUARDIANS
echo -e "\n${CYAN}=== 3. GUARDIAN MANAGEMENT ===${NC}"
guardian_create=$(test_api "Create Guardian" "POST" "$BASE_URL/guardians" '{"first_name":"Parent","last_name":"One","email":"parent@test.com","phone":"+234-900","relationship":"father"}')
GUARDIAN_ID=$(echo "$guardian_create" | jq -r '.guardian.id // .data.id // .id' 2>/dev/null)
test_api "List Guardians" "GET" "$BASE_URL/guardians"
if [ -n "$GUARDIAN_ID" ] && [ "$GUARDIAN_ID" != "null" ]; then
  test_api "Get Guardian Details" "GET" "$BASE_URL/guardians/$GUARDIAN_ID"
  test_api "Assign Student to Guardian" "POST" "$BASE_URL/guardians/$GUARDIAN_ID/assign-student" "{\"student_id\":$STUDENT_ID}"
  test_api "Get Guardian Students" "GET" "$BASE_URL/guardians/$GUARDIAN_ID/students"
fi

# 4. QUESTION BANKS
echo -e "\n${CYAN}=== 4. QUESTION BANKS ===${NC}"
test_api "List Question Banks" "GET" "$BASE_URL/question-banks"
qb_create=$(test_api "Create Question Bank" "POST" "$BASE_URL/question-banks" "{\"subject_id\":$SUBJECT_ID,\"class_id\":$CLASS_ID,\"title\":\"Test QB\",\"description\":\"Test questions\"}")
QB_ID=$(echo "$qb_create" | jq -r '.question_bank.id // .data.id // .id' 2>/dev/null)
if [ -n "$QB_ID" ] && [ "$QB_ID" != "null" ]; then
  test_api "Get Question Bank" "GET" "$BASE_URL/question-banks/$QB_ID"
fi

# 5. ADVANCED STUDENT OPERATIONS
echo -e "\n${CYAN}=== 5. ADVANCED STUDENT OPERATIONS ===${NC}"
test_api "Get Student Attendance" "GET" "$BASE_URL/students/$STUDENT_ID/attendance"
test_api "Get Student Results" "GET" "$BASE_URL/students/$STUDENT_ID/results"
test_api "Get Student Assignments" "GET" "$BASE_URL/students/$STUDENT_ID/assignments"
test_api "Get Student Subjects" "GET" "$BASE_URL/students/$STUDENT_ID/subjects"

# 6. ADVANCED TEACHER OPERATIONS
echo -e "\n${CYAN}=== 6. ADVANCED TEACHER OPERATIONS ===${NC}"
test_api "Get Teacher Classes" "GET" "$BASE_URL/teachers/$TEACHER_ID/classes"
test_api "Get Teacher Subjects" "GET" "$BASE_URL/teachers/$TEACHER_ID/subjects"

# 7. ADVANCED CLASS OPERATIONS
echo -e "\n${CYAN}=== 7. ADVANCED CLASS OPERATIONS ===${NC}"
test_api "Get Class Students" "GET" "$BASE_URL/classes/$CLASS_ID/students"

# 8. ANNOUNCEMENTS
echo -e "\n${CYAN}=== 8. ANNOUNCEMENTS ===${NC}"
test_api "List Announcements" "GET" "$BASE_URL/announcements"
ann_create=$(test_api "Create Announcement" "POST" "$BASE_URL/announcements" '{"title":"Test Announcement","content":"This is a test","priority":"normal"}')
ANN_ID=$(echo "$ann_create" | jq -r '.announcement.id // .data.id // .id' 2>/dev/null)
if [ -n "$ANN_ID" ] && [ "$ANN_ID" != "null" ]; then
  test_api "Get Announcement" "GET" "$BASE_URL/announcements/$ANN_ID"
  test_api "Update Announcement" "PUT" "$BASE_URL/announcements/$ANN_ID" '{"title":"Updated Announcement"}'
fi

# 9. EVENTS
echo -e "\n${CYAN}=== 9. EVENTS ===${NC}"
test_api "List Events" "GET" "$BASE_URL/events"
event_create=$(test_api "Create Event" "POST" "$BASE_URL/events" '{"title":"Test Event","description":"Test","start_date":"2026-02-01","end_date":"2026-02-02","event_type":"academic"}')
EVENT_ID=$(echo "$event_create" | jq -r '.event.id // .data.id // .id' 2>/dev/null)
if [ -n "$EVENT_ID" ] && [ "$EVENT_ID" != "null" ]; then
  test_api "Get Event" "GET" "$BASE_URL/events/$EVENT_ID"
fi

# 10. ADVANCED GRADING SYSTEM
echo -e "\n${CYAN}=== 10. ADVANCED GRADING SYSTEM ===${NC}"
test_api "Create Grading System" "POST" "$BASE_URL/assessments/grading-systems" '{"name":"Test Grading","grade_boundaries":[{"min":70,"max":100,"grade":"A","remark":"Excellent"}],"pass_mark":50}'

# 11. ADVANCED TIMETABLE
echo -e "\n${CYAN}=== 11. ADVANCED TIMETABLE ===${NC}"
tt_create=$(test_api "Create Timetable Entry" "POST" "$BASE_URL/timetable" "{\"class_id\":$CLASS_ID,\"subject_id\":$SUBJECT_ID,\"teacher_id\":$TEACHER_ID,\"day\":\"monday\",\"start_time\":\"09:00\",\"end_time\":\"10:00\"}")
TT_ID=$(echo "$tt_create" | jq -r '.timetable.id // .data.id // .id' 2>/dev/null)

# 12. ADVANCED LIBRARY
echo -e "\n${CYAN}=== 12. ADVANCED LIBRARY ===${NC}"
book_create=$(test_api "Create Library Book" "POST" "$BASE_URL/library/books" '{"title":"Test Book","author":"Test Author","isbn":"123456","total_copies":5,"available_copies":5}')
BOOK_ID=$(echo "$book_create" | jq -r '.book.id // .data.id // .id' 2>/dev/null)
if [ -n "$BOOK_ID" ] && [ "$BOOK_ID" != "null" ]; then
  test_api "Update Library Book" "PUT" "$BASE_URL/library/books/$BOOK_ID" '{"total_copies":10}'
  test_api "Borrow Book" "POST" "$BASE_URL/library/books/$BOOK_ID/borrow" "{\"student_id\":$STUDENT_ID,\"due_date\":\"2026-02-28\"}"
fi

# 13. ADVANCED HOUSES
echo -e "\n${CYAN}=== 13. ADVANCED HOUSES ===${NC}"
house_create=$(test_api "Create House" "POST" "$BASE_URL/houses" '{"name":"Red House","color":"red"}')
HOUSE_ID=$(echo "$house_create" | jq -r '.house.id // .data.id // .id' 2>/dev/null)
if [ -n "$HOUSE_ID" ] && [ "$HOUSE_ID" != "null" ]; then
  test_api "Update House" "PUT" "$BASE_URL/houses/$HOUSE_ID" '{"color":"crimson"}'
  test_api "Add House Points" "POST" "$BASE_URL/houses/$HOUSE_ID/points" '{"points":10,"reason":"Good behavior"}'
fi

# 14. ADVANCED SPORTS
echo -e "\n${CYAN}=== 14. ADVANCED SPORTS ===${NC}"
test_api "Create Sport Activity" "POST" "$BASE_URL/sports/activities" '{"name":"Basketball","description":"School basketball"}'
test_api "Create Sport Team" "POST" "$BASE_URL/sports/teams" '{"name":"Blue Team","sport":"Basketball"}'
test_api "Create Sport Event" "POST" "$BASE_URL/sports/events" '{"title":"Basketball Match","date":"2026-02-15","venue":"School Court"}'

# 15. ADVANCED ACHIEVEMENTS
echo -e "\n${CYAN}=== 15. ADVANCED ACHIEVEMENTS ===${NC}"
ach_create=$(test_api "Create Achievement" "POST" "$BASE_URL/achievements" '{"title":"Best Student","description":"Top performer","category":"academic"}')
ACH_ID=$(echo "$ach_create" | jq -r '.achievement.id // .data.id // .id' 2>/dev/null)
if [ -n "$ACH_ID" ] && [ "$ACH_ID" != "null" ]; then
  test_api "Update Achievement" "PUT" "$BASE_URL/achievements/$ACH_ID" '{"description":"Best academic performer"}'
fi

# Cleanup
echo -e "\n${CYAN}=== CLEANUP ===${NC}"
curl -s -X DELETE "$BASE_URL/schools/$SCHOOL_ID?force=true&delete_database=true" -H "Authorization: Bearer $SUPER_TOKEN" 2>&1

echo -e "\n${CYAN}================================${NC}"
echo -e "${GREEN}✅ Passed: $PASSED${NC}"
echo -e "${RED}❌ Failed: $FAILED${NC}"
echo -e "${CYAN}Total: $((PASSED + FAILED))${NC}"
